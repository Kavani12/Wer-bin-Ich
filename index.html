<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wer bin ich? â€“ Multiplayer</title>
  <style>
    :root { --bg:#0f1115; --card:#151922; --muted:#a8b0bf; --accent:#7c5cff; --ok:#3ddc97; --warn:#ffb703; --danger:#ef476f; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:#e7ecf5;}
    .wrap{max-width:980px;margin:0 auto;padding:24px;}
    h1{font-size:28px;margin:0 0 12px}
    .card{background:var(--card);border:1px solid #232a36;border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35);}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:280px}
    button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #2b3241}
    button:disabled{opacity:.5;cursor:not-allowed}
    input,textarea,select{width:100%;background:#0e121a;color:#e7ecf5;border:1px solid #252c39;border-radius:12px;padding:10px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:14px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0e121a;border:1px solid #263043;padding:6px 10px;border-radius:999px;font-size:13px;color:#c6ccda}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    .player{padding:10px;border:1px solid #2b3241;border-radius:12px;background:#0e121a}
    .state{margin-top:8px}
    .hint{font-size:13px;color:var(--muted)}
    .sep{height:1px;background:#222a36;margin:16px 0}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#1c2331;border:1px solid #2b3241;color:#cfd7ea}
    .muted{color:var(--muted)}
    .vote{display:flex;align-items:center;gap:8px;padding:10px;border:1px solid #2b3241;border-radius:12px;background:#0e121a}
    .small{font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .countdown{font-size:20px;font-weight:bold;color:var(--warn);margin-top:10px;}
    .progress{width:100%;height:16px;background:#2b3241;border-radius:8px;overflow:hidden;margin-top:6px;}
    .progress-bar{height:100%;background:var(--accent);width:0%;transition:width 0.25s linear;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="titlebar">
    <h1>ðŸŽ­ Wer bin ich? â€“ Multiplayer</h1>
    <div id="roomPill" class="pill">Kein Raum</div>
  </div>

  <!-- Auth -->
  <div class="card" id="authCard">
    <div class="row">
      <div class="col">
        <label>Dein Name</label>
        <input id="playerName" placeholder="z.B. Noel" maxlength="20"/>
      </div>
      <div class="col">
        <label>Raum-ID</label>
        <input id="roomId" placeholder="z.B. PIZZA42" maxlength="16"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnHost">Spiel hosten</button>
      <button id="btnJoin" class="ghost">Beitreten</button>
    </div>
    <div class="hint" style="margin-top:8px">Tipp: Kurze Raum-ID wÃ¤hlen und teilen.</div>
  </div>

  <!-- Lobby -->
  <div class="card" id="lobbyCard" style="display:none">
    <div class="row">
      <div class="col">
        <div class="badge">Lobby</div>
        <h2 id="isHostTag" style="margin:6px 0 12px"></h2>
        <div class="grid" id="players"></div>
        <div class="state">
          <button id="btnReady">Bereit</button>
          <button id="btnUnready" class="ghost">Nicht bereit</button>
          <span id="readyInfo" class="muted" style="margin-left:8px"></span>
        </div>
        <div id="countdown" class="countdown" style="display:none"></div>
        <div class="progress" style="display:none" id="countdownBar"><div class="progress-bar" id="countdownFill"></div></div>
      </div>
      <div class="col">
        <label>Charakter-Pool (nur Host)</label>
        <textarea id="pool" rows="10" placeholder="Jede Zeile ein Charakter"></textarea>
        <div class="small muted" style="margin-top:6px">Wenn leer, wird ein Standard-Pool benutzt.</div>
      </div>
    </div>
  </div>

  <!-- VorschlÃ¤ge -->
  <div class="card" id="phaseSuggest" style="display:none">
    <div class="badge">Phase: VorschlÃ¤ge</div>
    Die Zielperson ist <b><span id="targetNameA" class="mono"></span></b>.
    <div class="muted small" style="margin:10px 0">Alle auÃŸer der Zielperson geben je <b>einen</b> Charakter-Vorschlag ab.</div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC03LUB1LEJYsmdwB9P61j571zIoHMDe0w",
  authDomain: "wer-bin-ich-c30fd.firebaseapp.com",
  databaseURL: "https://wer-bin-ich-c30fd-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "wer-bin-ich-c30fd",
  storageBucket: "wer-bin-ich-c30fd.appspot.com",
  messagingSenderId: "477823647225",
  appId: "1:477823647225:web:4885243f5323e2d3c95128"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const byId = (id)=>document.getElementById(id);
const uid = ()=> Math.random().toString(36).slice(2,10);

let me = { id: uid(), name: "", room: "", isHost: false };
let unsub = [];
let playerMap = {};
let countdownTimer = null;

const DEFAULT_POOL = ["Angela Merkel","Harry Potter","Darth Vader","Spongebob","Sherlock Holmes"];

function roomRef(room){ return db.ref(`rooms/${room}`); }
function playersRef(room){ return db.ref(`rooms/${room}/players`); }
function setState(room, patch){ return roomRef(room).update(patch); }

function setupPlayerMap(){
  if(!me.room) return;
  const off = playersRef(me.room).on('value', snap=>{ playerMap = snap.val()||{}; });
  unsub.push(()=>playersRef(me.room).off('value', off));
}
function getPlayerName(id){ return playerMap?.[id]?.name || null; }

async function hostGame(){
  me.name = byId('playerName').value.trim();
  me.room = (byId('roomId').value.trim() || makeRoomId()).toUpperCase();
  if(!me.name){ return alert('Bitte Namen eingeben.'); }
  me.isHost = true;
  const now = Date.now();
  await roomRef(me.room).set({ createdAt: now, hostId: me.id, state: 'lobby', round: 0, targetId: null });
  await playersRef(me.room).child(me.id).set({ id: me.id, name: me.name, ready:false, joinedAt: now });
  enterLobby();
}
async function joinGame(){
  me.name = byId('playerName').value.trim();
  me.room = byId('roomId').value.trim().toUpperCase();
  if(!me.name || !me.room){ return alert('Name und Raum-ID nÃ¶tig.'); }
  me.isHost = false;
  const now = Date.now();
  await playersRef(me.room).child(me.id).set({ id: me.id, name: me.name, ready:false, joinedAt: now });
  enterLobby();
}
function makeRoomId(){
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let out=''; for(let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
  byId('roomId').value = out; return out;
}
function show(cardId){
  ['authCard','lobbyCard','phaseSuggest'].forEach(id=> byId(id).style.display='none');
  byId(cardId).style.display='block';
}

function enterLobby(){
  setupPlayerMap();
  show('lobbyCard');

  const off1 = playersRef(me.room).on('value', async snap => {
    const players = snap.val()||{};
    renderPlayers(players);
    const list = Object.values(players);
    const readyCount = list.filter(p=>p.ready).length;
    byId('readyInfo').textContent = `${readyCount}/${list.length} bereit`;

    const rSnap = await roomRef(me.room).get();
    const data = rSnap.val()||{};
    const everyoneReady = list.length>=3 && readyCount===list.length;
    if(me.isHost){
      if(everyoneReady && data.state==='lobby'){
        await roomRef(me.room).update({ state:'countdown', countdownStart: Date.now(), countdownMs: 5000 });
      }
      if(!everyoneReady && data.state==='countdown'){
        await roomRef(me.room).update({ state:'lobby', countdownStart: null, countdownMs: null });
      }
    }
  });
  unsub.push(()=>playersRef(me.room).off('value', off1));

  const off2 = roomRef(me.room).on('value', async snap => {
    const data = snap.val(); if(!data) return;
    if(data.state==='countdown') handleCountdownUI(data); else clearCountdownUI();
    if(data.state==='suggest') enterSuggestPhase(data);
    if(me.isHost && data.state==='countdown' && data.countdownStart && data.countdownMs){
      const remaining = data.countdownStart + data.countdownMs - Date.now();
      if(remaining <= 0){
        await roomRef(me.room).update({ countdownStart: null, countdownMs: null });
        await startRound();
      }
    }
  });
  unsub.push(()=>roomRef(me.room).off('value', off2));
}

function handleCountdownUI(data){
  byId('countdown').style.display='block';
  byId('countdownBar').style.display='block';
  const update = ()=>{
    const end = (data.countdownStart||0) + (data.countdownMs||0);
    const ms = Math.max(0, end - Date.now());
    const sec = Math.ceil(ms/1000);
    byId('countdown').textContent = `Spiel startet in ${sec}â€¦`;
    const total = data.countdownMs||5000;
    const percent = Math.min(100, (1 - ms/total)*100);
    byId('countdownFill').style.width = percent + \"%\";
  };
  update();
  clearInterval(countdownTimer);
  countdownTimer = setInterval(update, 200);
}
function clearCountdownUI(){
  clearInterval(countdownTimer); countdownTimer=null;
  byId('countdown').style.display='none';
  byId('countdownBar').style.display='none';
  byId('countdownFill').style.width = \"0%\";
}

function renderPlayers(players){
  const el = byId('players'); el.innerHTML='';
  Object.values(players).forEach(p=>{
    const div=document.createElement('div');
    div.className='player';
    div.innerHTML = `<div><b>${p.name}</b></div><div class=\"small muted\">${p.ready?'bereit âœ”':'wartetâ€¦'}</div>`;
    el.appendChild(div);
  });
}

byId('btnReady').onclick = ()=> playersRef(me.room).child(me.id).update({ready:true});
byId('btnUnready').onclick = ()=> playersRef(me.room).child(me.id).update({ready:false});

async function startRound(){
  if(!me.isHost) return;
  const pSnap = await playersRef(me.room).get();
  const players = Object.values(pSnap.val()||{});
  if(players.length<3) return;
  const target = players[Math.floor(Math.random()*players.length)];
  await setState(me.room, { state:'suggest', targetId: target.id, countdownStart:null, countdownMs:null });
}
function enterSuggestPhase(data){
  show('phaseSuggest');
  byId('targetNameA').textContent = getPlayerName(data.targetId)||'?';
}

byId('btnHost').onclick = hostGame;
byId('btnJoin').onclick = joinGame;
</script>
</body>
</html>

