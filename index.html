<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wer bin ich? ‚Äì Multiplayer</title>
  <style>
    :root {
      --bg: #0f1115; --card:#151922; --muted:#a8b0bf; --accent:#7c5cff;
      --ok:#3ddc97; --warn:#ffb703; --danger:#ef476f;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:#e7ecf5;}
    .wrap{max-width:980px;margin:0 auto;padding:24px;}
    h1{font-size:28px;margin:0 0 12px}
    .card{background:var(--card);border:1px solid #232a36;border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35);}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:280px}
    button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #2b3241}
    button:disabled{opacity:.5;cursor:not-allowed}
    input,textarea,select{width:100%;background:#0e121a;color:#e7ecf5;border:1px solid #252c39;border-radius:12px;padding:10px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:14px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0e121a;border:1px solid #263043;padding:6px 10px;border-radius:999px;font-size:13px;color:#c6ccda}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    .player{padding:10px;border:1px solid #2b3241;border-radius:12px;background:#0e121a}
    .tag{font-size:12px;color:#9fb0ff}
    .state{margin-top:8px}
    .hint{font-size:13px;color:var(--muted)}
    .sep{height:1px;background:#222a36;margin:16px 0}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#1c2331;border:1px solid #2b3241;color:#cfd7ea}
    .success{color:var(--ok)}
    .warn{color:var(--warn)}
    .danger{color:var(--danger)}
    .center{display:flex;align-items:center;justify-content:center}
    .titlebar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .muted{color:var(--muted)}
    .vote{display:flex;align-items:center;gap:8px;padding:10px;border:1px solid #2b3241;border-radius:12px;background:#0e121a}
    .small{font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
<div class="wrap">
  <div class="titlebar">
    <h1>üé≠ Wer bin ich? ‚Äì Multiplayer</h1>
    <div id="roomPill" class="pill">Kein Raum</div>
  </div>

  <div class="card" id="authCard">
    <div class="row">
      <div class="col">
        <label>Dein Name</label>
        <input id="playerName" placeholder="z.B. Noel" maxlength="20"/>
      </div>
      <div class="col">
        <label>Raum-ID</label>
        <input id="roomId" placeholder="z.B. PIZZA42" maxlength="16"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnHost">Spiel hosten</button>
      <button id="btnJoin" class="ghost">Beitreten</button>
    </div>
    <div class="hint" style="margin-top:8px">Tipp: Verwende eine kurze Raum-ID und teile sie mit deinen Freund:innen.</div>
  </div>

  <div class="card" id="lobbyCard" style="display:none">
    <div class="row">
      <div class="col">
        <div class="badge">Lobby</div>
        <h2 id="isHostTag" style="margin:6px 0 12px"></h2>
        <div class="grid" id="players"></div>
        <div class="state">
          <button id="btnReady">Bereit</button>
          <button id="btnUnready" class="ghost">Nicht bereit</button>
          <span id="readyInfo" class="muted" style="margin-left:8px"></span>
        </div>
      </div>
      <div class="col">
        <label>Charakter-Pool (nur Host)</label>
        <textarea id="pool" rows="10" placeholder="Jede Zeile ein Charakter (z.B. Angela Merkel, Spongebob, Harry Potter)"></textarea>
        <div class="small muted" style="margin-top:6px">Wenn leer, wird ein Standard-Pool benutzt.</div>
        <div class="sep"></div>
        <button id="btnStart" disabled>Runde starten (Host)</button>
      </div>
    </div>
  </div>

  <div class="card" id="phaseSuggest" style="display:none">
    <div class="badge">Phase: Vorschl√§ge</div>
    <h2>Vorschl√§ge f√ºr <span id="targetNameA" class="mono"></span></h2>
    <div class="muted small" style="margin-bottom:10px">Alle au√üer der Zielperson geben je <b>einen</b> Charakter-Vorschlag ab.</div>
    <div class="row">
      <div class="col">
        <label>Dein Vorschlag</label>
        <input id="suggestInput" placeholder="z.B. Sherlock Holmes" maxlength="40" />
      </div>
      <div class="col" style="align-self:end">
        <button id="btnSuggest">Vorschlag senden</button>
      </div>
    </div>
    <div class="sep"></div>
    <div>
      <div class="small muted">Eingegangene Vorschl√§ge:</div>
      <div id="suggestList" class="grid"></div>
    </div>
    <div class="sep"></div>
    <div class="row">
      <button id="btnLockSuggests" class="ghost">Host: Vorschlagsphase beenden</button>
    </div>
  </div>

  <div class="card" id="phaseVote" style="display:none">
    <div class="badge">Phase: Abstimmung</div>
    <h2>Abstimmen f√ºr <span id="targetNameB" class="mono"></span></h2>
    <div class="grid" id="voteOptions"></div>
    <div class="sep"></div>
    <div class="small muted">Klicke auf deinen Favoriten. Zielperson darf (optional) auch mitvoten.</div>
  </div>

  <div class="card" id="phaseResult" style="display:none">
    <div class="badge">Ergebnis</div>
    <h2><span id="winnerChar" class="mono"></span> gewinnt f√ºr <span id="targetNameC" class="mono"></span> üéâ</h2>
    <div class="muted" id="voteBreakdown"></div>
    <div class="sep"></div>
    <div class="row">
      <button id="btnNextRound">N√§chste Runde</button>
      <button id="btnBackLobby" class="ghost">Zur√ºck zur Lobby</button>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="small muted">Backend: Firebase Realtime Database. Trage deine Config unten ein und hoste die Datei statisch (z.B. GitHub Pages, Netlify, Vercel).<br>Siehe Kommentar im Code: <span class="mono">// TODO: Firebase Config</span></div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
// =========================
// üîß TODO: Firebase Config
// =========================
// Erstelle ein Firebase-Projekt ‚Üí Realtime Database (Modus: test/read+write, sp√§ter Regeln anpassen)
// Kopiere hier deine Web-App Config rein:
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== Helpers =====
const $ = sel => document.querySelector(sel);
const byId = id => document.getElementById(id);
const uid = () => Math.random().toString(36).slice(2, 10);

let me = { id: uid(), name: "", room: "", isHost: false };
let unsub = [];

const DEFAULT_POOL = [
  "Angela Merkel","Harry Potter","Darth Vader","Spongebob","Sherlock Holmes",
  "Taylor Swift","Batman","Asterix","Geralt von Riva","Mona Lisa","Albert Einstein",
  "Elon Musk","Shrek","Spider-Man","Mario","Luigi","Indiana Jones","Katniss Everdeen"
];

function roomRef(room){ return db.ref(`rooms/${room}`); }
function playersRef(room){ return db.ref(`rooms/${room}/players`); }

function setState(room, patch){ return roomRef(room).update(patch); }

function setPill(text){ byId('roomPill').textContent = text; }

function cleanListeners(){ unsub.forEach(u=>u()); unsub=[]; }

// ===== Auth / Room =====
async function hostGame(){
  me.name = byId('playerName').value.trim();
  me.room = (byId('roomId').value.trim() || makeRoomId()).toUpperCase();
  if(!me.name){ return alert('Bitte Namen eingeben.'); }
  me.isHost = true;

  const rRef = roomRef(me.room);
  const now = Date.now();
  await rRef.set({
    createdAt: now,
    hostId: me.id,
    state: 'lobby', // lobby | suggest | vote | result
    round: 0,
    targetId: null,
    pool: DEFAULT_POOL,
    suggestsLocked: false
  });
  await playersRef(me.room).child(me.id).set({ id: me.id, name: me.name, ready:false, joinedAt: now });
  enterLobby();
}

async function joinGame(){
  me.name = byId('playerName').value.trim();
  me.room = byId('roomId').value.trim().toUpperCase();
  if(!me.name || !me.room){ return alert('Name und Raum-ID n√∂tig.'); }
  me.isHost = false;
  const now = Date.now();
  // create room if not exists? no ‚Üí user should host
  await playersRef(me.room).child(me.id).set({ id: me.id, name: me.name, ready:false, joinedAt: now });
  enterLobby();
}

function makeRoomId(){
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let out='';
  for(let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
  byId('roomId').value = out;
  return out;
}

// ===== UI Transitions =====
function show(cardId){
  ['authCard','lobbyCard','phaseSuggest','phaseVote','phaseResult'].forEach(id=> byId(id).style.display='none');
  byId(cardId).style.display='block';
}

function enterLobby(){
  setupPlayerMap();

  setPill(`Raum: ${me.room}`);
  byId('isHostTag').textContent = me.isHost ? 'Du bist Host' : 'Du bist Spieler';
  show('lobbyCard');

  // live players list
  const off1 = playersRef(me.room).on('value', snap => {
    const players = snap.val()||{};
    renderPlayers(players);
    const list = Object.values(players);
    const readyCount = list.filter(p=>p.ready).length;
    byId('readyInfo').textContent = `${readyCount}/${list.length} bereit`;
    byId('btnStart').disabled = !(me.isHost && list.length>=3 && readyCount===list.length);
  });
  unsub.push(()=>playersRef(me.room).off('value', off1));

  // room state listener
  const off2 = roomRef(me.room).on('value', snap => {
    const data = snap.val(); if(!data) return;
    // sync pool UI for host
    if(me.isHost){ byId('pool').value = (data.pool||[]).join('\n'); }

    if(data.state==='suggest') enterSuggestPhase(data);
    else if(data.state==='vote') enterVotePhase(data);
    else if(data.state==='result') enterResultPhase(data);
    else if(data.state==='lobby') show('lobbyCard');
  });
  unsub.push(()=>roomRef(me.room).off('value', off2));
}

function renderPlayers(players){
  const el = byId('players'); el.innerHTML='';
  Object.values(players).sort((a,b)=>a.joinedAt-b.joinedAt).forEach(p=>{
    const div=document.createElement('div');
    div.className='player';
    div.innerHTML = `<div><b>${escapeHtml(p.name)}</b></div>
      <div class="small muted">${p.id===me.id? 'Das bist du' : 'Mitspieler'}</div>
      <div style="margin-top:6px"><span class="badge" style="border-color:${p.ready?'#1f4739':'#47311f'};color:${p.ready?'#a8f0cf':'#f0d0a8'}">${p.ready?'bereit ‚úî':'wartet‚Ä¶'}</span></div>`;
    el.appendChild(div);
  });
}

function escapeHtml(s){return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}

// ===== Lobby Actions =====
byId('btnReady').onclick = ()=> playersRef(me.room).child(me.id).update({ready:true});
byId('btnUnready').onclick = ()=> playersRef(me.room).child(me.id).update({ready:false});
byId('btnStart').onclick = async ()=>{
  // apply pool if host edited
  if(me.isHost){
    const lines = byId('pool').value.split('\n').map(x=>x.trim()).filter(Boolean);
    const pool = lines.length? lines : DEFAULT_POOL;
    await setState(me.room, { pool });
  }
  await startRound();
};

async function startRound(){
  const pSnap = await playersRef(me.room).get();
  const players = Object.values(pSnap.val()||{});
  if(players.length<3) return alert('Mindestens 3 Spieler.');
  // pick random target among ready players
  const readyPlayers = players.filter(p=>p.ready);
  const target = readyPlayers[Math.floor(Math.random()*readyPlayers.length)];

  // reset fields for new round
  const updates = {};
  updates[`rooms/${me.room}/round`] = firebase.database.ServerValue.increment(1);
  updates[`rooms/${me.room}/state`] = 'suggest';
  updates[`rooms/${me.room}/targetId`] = target.id;
  updates[`rooms/${me.room}/suggestsLocked`] = false;
  updates[`rooms/${me.room}/suggests`] = null;
  updates[`rooms/${me.room}/votes`] = null;
  await db.ref().update(updates);
}

// ===== Suggest Phase =====
function enterSuggestPhase(data){
  show('phaseSuggest');
  const target = data.targetId;
  const targetName = getPlayerName(target);
  byId('targetNameA').textContent = targetName||'(unbekannt)';

  // render list of suggestions live
  const sRef = roomRef(me.room).child('suggests');
  const off = sRef.on('value', snap=>{
    const obj = snap.val()||{}; renderSuggestList(obj, target);
  });
  unsub.push(()=>sRef.off('value', off));

  byId('btnSuggest').disabled = false;
  byId('suggestInput').value = '';

  byId('btnSuggest').onclick = async ()=>{
    const val = byId('suggestInput').value.trim();
    if(!val) return alert('Bitte einen Vorschlag eingeben.');
    // target cannot submit
    if(me.id===target) return alert('Die Zielperson darf keinen Vorschlag abgeben.');
    const key = me.id; // one per player
    await roomRef(me.room).child('suggests').child(key).set({ by: me.id, text: val, at: Date.now() });
    byId('btnSuggest').disabled = true;
  };

  byId('btnLockSuggests').style.display = me.isHost? 'inline-flex':'none';
  byId('btnLockSuggests').onclick = async ()=>{
    await setState(me.room, { suggestsLocked: true, state: 'vote' });
  };
}

function renderSuggestList(obj, targetId){
  const el = byId('suggestList'); el.innerHTML = '';
  const items = Object.values(obj);
  if(items.length===0){ el.innerHTML = '<div class="muted small">Noch keine Vorschl√§ge‚Ä¶</div>'; return; }
  items.sort((a,b)=>a.at-b.at).forEach(s=>{
    const div = document.createElement('div');
    div.className='player';
    const byName = getPlayerName(s.by)||'?' ;
    div.innerHTML = `<div><b>${escapeHtml(s.text)}</b></div><div class="small muted">von ${escapeHtml(byName)}</div>`;
    el.appendChild(div);
  });
}

// ===== Vote Phase =====
function enterVotePhase(data){
  show('phaseVote');
  const target = data.targetId;
  byId('targetNameB').textContent = getPlayerName(target)||'(unbekannt)';

  // read suggestions once
  roomRef(me.room).child('suggests').get().then(snap=>{
    const obj = snap.val()||{};
    renderVoteOptions(obj);
  });
}

function renderVoteOptions(obj){
  const el = byId('voteOptions'); el.innerHTML='';
  const entries = Object.values(obj);
  if(entries.length===0){ el.innerHTML = '<div class="muted small">Keine Vorschl√§ge vorhanden.</div>'; return; }

  entries.forEach((s, idx)=>{
    const row = document.createElement('div');
    row.className='vote';
    row.innerHTML = `<div style="flex:1"><b>${escapeHtml(s.text)}</b><div class="small muted">von ${escapeHtml(getPlayerName(s.by)||'?')}</div></div>`;
    const btn = document.createElement('button');
    btn.textContent='Stimme geben';
    btn.onclick = async ()=>{
      await roomRef(me.room).child('votes').child(me.id).set({ choiceIdx: idx, at: Date.now() });
      // disable all buttons
      [...el.querySelectorAll('button')].forEach(b=>b.disabled=true);
    };
    row.appendChild(btn);
    el.appendChild(row);
  });

  // live watch votes; when alle haben gevotet ‚áí tally
  const off = playersRef(me.room).on('value', async snap=>{
    const players = Object.values(snap.val()||{});
    const vSnap = await roomRef(me.room).child('votes').get();
    const votes = vSnap.val()||{};
    const votedCount = Object.keys(votes).length;
    const total = players.length; // inkl. Zielperson
    if(votedCount===total){ tallyAndFinish(entries); }
  });
  unsub.push(()=>playersRef(me.room).off('value', off));
}

async function tallyAndFinish(entries){
  // tally votes
  const vSnap = await roomRef(me.room).child('votes').get();
  const votes = Object.values(vSnap.val()||{});
  const counts = new Array(entries.length).fill(0);
  votes.forEach(v=>{ if(v && Number.isInteger(v.choiceIdx)) counts[v.choiceIdx]++; });
  // pick max; tie-breaker: earliest suggestion
  let winIdx = 0, max=-1;
  counts.forEach((c,i)=>{ if(c>max){ max=c; winIdx=i; } });
  const winner = entries[winIdx];

  await setState(me.room, {
    state:'result',
    result:{ winnerIdx: winIdx, counts, entries }
  });
}

// ===== Result Phase =====
function enterResultPhase(data){
  show('phaseResult');
  const res = data.result||{};
  const entries = res.entries||[];
  const win = entries[res.winnerIdx] || { text:'(keiner)', by:'' };
  byId('winnerChar').textContent = win.text;
  byId('targetNameC').textContent = getPlayerName(data.targetId)||'?';

  const breakdown = (res.counts||[]).map((c,i)=>`<div>‚Ä¢ ${escapeHtml(entries[i]?.text||'?')} ‚Äì <b>${c}</b> Stimmen</div>`).join('');
  byId('voteBreakdown').innerHTML = breakdown;

  byId('btnNextRound').onclick = ()=> startRound();
  byId('btnBackLobby').onclick = ()=> setState(me.room, { state:'lobby' });
}

function getPlayerName(id){
  // read from cache in DOM list
  // quick fetch each time (cheap):
  // NOTE: in production, keep a local map in listeners
  return byId('players')
    .querySelectorAll('.player')
    .length ?
    Array.from(byId('players').querySelectorAll('.player'))
      .map(div=>div.querySelector('b')?.textContent) && null : null;
}

// Improve getPlayerName: maintain map
let playerMap = {};
function setupPlayerMap(){

  if(!me.room) return;
  const off = playersRef(me.room).on('value', snap=>{
    playerMap = snap.val()||{};
  });
  unsub.push(()=>playersRef(me.room).off('value', off));
}

function getPlayerName(id){ return playerMap?.[id]?.name || null; }

// ===== Wire buttons =====
byId('btnHost').onclick = hostGame;
byId('btnJoin').onclick = joinGame;

// Basic runtime error surfacing for buttons (helps, falls Firebase fehlt)
window.addEventListener('error', (e)=>{
  console.warn('JS Error:', e.message);
});

// update map on page load if room set
setupPlayerMap();
</script>
</body>
</html>
